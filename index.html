<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SatélitesArg - Visualizador Satelital</title>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

	<script src="https://cdn.tailwindcss.com"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js" defer></script>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

	<style>
		/* ==========================================================================
		   PALETA DE COLORES Y ESTILO BASE - TECH/ESPACIAL
		   ========================================================================== */
		:root {
			--color-background: #0D1117; /* Azul oscuro casi negro */
			--color-surface: #161B22;   /* Azul oscuro más claro para superficies */
			--color-primary: #3081F7;     /* Azul brillante para acentos */
			--color-secondary: #58A6FF;  /* Azul claro */
			--color-accent: #1F6FEB;     /* Azul de acento */
			--color-text-primary: #C9D1D9; /* Texto principal (gris claro) */
			--color-text-secondary: #8B949E;/* Texto secundario (gris) */
			--color-success: #39D353;     /* Verde para éxito */
			--color-danger: #F85149;      /* Rojo para errores */
            --color-warning: #F7B530;     /* Naranja/amarillo para advertencias */
			--color-orbit: var(--color-warning); /* Amarillo/Naranja para la órbita */
		}

		body {
			font-family: 'Inter', sans-serif;
			background-color: var(--color-background);
			color: var(--color-text-primary);
			overflow: hidden;
			user-select: none;
			cursor: default;
		}
		
		::selection {
			background-color: var(--color-primary);
			color: white;
		}

		/* Helper para ocultar elementos */
		.hidden {
			display: none !important;
		}

		.hide-for-screenshot {
			visibility: hidden !important; /* Usar visibility para no afectar el layout */
		}
		
		/* Contenedor de pantalla principal */
		.screen {
			width: 100vw;
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			padding: 2rem;
			animation: fadeIn 0.5s ease-out forwards;
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: scale(0.98); }
			to { opacity: 1; transform: scale(1); }
		}

		/* ==========================================================================
		   COMPONENTES DE UI (BOTONES, INPUTS, MODALES)
		   ========================================================================== */

		.btn {
			font-weight: 500;
			padding: 0.6rem 1.2rem;
			border-radius: 8px;
			border: 1px solid transparent;
			transition: all 0.2s ease-in-out;
			cursor: pointer;
			-webkit-tap-highlight-color: transparent;
		}
		.btn-primary {
			background-color: var(--color-primary);
			color: white;
			box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
		}
		.btn-primary:hover {
			background-color: var(--color-secondary);
		}
		.btn-primary:disabled {
			background-color: #30363d;
			color: #8b949e;
			cursor: not-allowed;
			box-shadow: none;
		}
		.btn-secondary {
			background-color: var(--color-surface);
			color: var(--color-text-primary);
			border-color: #30363d;
		}
		.btn-secondary:hover {
			border-color: var(--color-secondary);
			color: var(--color-secondary);
		}
        .btn-danger {
            background-color: var(--color-danger);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(248, 81, 73, 0.3);
        }
        .btn-danger:hover {
            background-color: #ff6b64;
        }

		.input-field, .textarea-field {
			background-color: var(--color-background);
			border: 1px solid #30363d;
			color: var(--color-text-primary);
			padding: 0.6rem;
			border-radius: 8px;
			width: 100%;
			transition: border-color 0.2s ease, box-shadow 0.2s ease;
		}
		.input-field:focus, .textarea-field:focus {
			outline: none;
			border-color: var(--color-primary);
			box-shadow: 0 0 0 3px rgba(48, 129, 247, 0.3);
		}
		.input-field::placeholder, .textarea-field::placeholder {
			color: var(--color-text-secondary);
		}
		
		.modal-overlay {
			position: fixed; inset: 0;
			background-color: rgba(13, 17, 23, 0.8);
			backdrop-filter: blur(5px);
			z-index: 1000;
			display: flex; justify-content: center; align-items: center;
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
		}
		.modal-overlay.is-visible { 
			opacity: 1; 
			pointer-events: auto;
		}
		
		.modal-content {
			background-color: var(--color-surface);
			color: var(--color-text-primary);
			padding: 2rem;
			border: 1px solid #30363d;
			box-shadow: 0 10px 30px rgba(0,0,0,0.5);
			border-radius: 12px;
			width: clamp(320px, 90vw, 700px);
			max-height: 90vh;
			overflow-y: auto;
			transform: scale(0.95);
			opacity: 0;
			transition: opacity 0.3s 0.1s ease, transform 0.3s 0.1s ease;
		}
		.is-visible .modal-content {
			opacity: 1;
			transform: scale(1);
		}
		.modal-content h3 {
			font-size: 1.5rem;
			font-weight: 700;
			margin-bottom: 1.5rem;
			padding-bottom: 0.75rem;
			border-bottom: 1px solid #30363d;
		}
        
        /* ESTILOS PARA FAVORITOS Y ESTADOS DE CARGA */
        .favorite-btn {
            color: var(--color-text-secondary);
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .favorite-btn:hover {
            transform: scale(1.15);
        }
        .favorite-btn.is-favorite {
            color: var(--color-danger);
        }
		/* Estilos para satélites en carga o con error */
		.known-satellite-item.is-loading .known-satellite-btn,
		.known-satellite-item.is-error .known-satellite-btn {
			cursor: not-allowed;
			opacity: 0.6;
		}

		/* ==========================================================================
		   ESTILOS DEL MAPA Y ELEMENTOS
		   ========================================================================== */

		#map-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
		#map {
			width: 100%;
			height: 100%;
			background-color: var(--color-background);
		}
		.leaflet-tile-pane {
			filter: brightness(0.9) contrast(1.1);
		}
		.leaflet-tile-pane.light-map {
			filter: brightness(1) contrast(1); /* Sin filtro para el mapa claro */
		}
		.leaflet-tile-pane.satellite-map {
			filter: saturate(1.1) contrast(1.05); /* Ajuste sutil para el satelital */
		}

		.leaflet-control-zoom, .leaflet-control-attribution {
			display: none;
		}
		
		/* ==================================================================
		   INICIO DE LA MODIFICACIÓN: ZOOM FLUIDO Y SIN PARPADEOS
		   ================================================================== */
		.leaflet-zoom-anim .leaflet-zoom-animated {
			/* Hacemos la animación de zoom casi instantánea (75ms) */
			transition: transform 0.075s cubic-bezier(0,0,0.25,1);
		}
		/* ==================================================================
		   FIN DE LA MODIFICACIÓN
		   ================================================================== */

		.satellite-dot-icon {
			width: 12px;
			height: 12px;
			background-color: var(--color-orbit);
			border-radius: 50%;
			border: 2px solid rgba(255, 255, 255, 0.7);
			box-shadow: 0 0 8px var(--color-orbit), 0 0 12px var(--color-orbit);
			animation: pulse-dot 1.5s infinite ease-in-out;
		}

		@keyframes pulse-dot {
			0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(247, 181, 48, 0.7); }
			70% { transform: scale(1); box-shadow: 0 0 8px 10px rgba(247, 181, 48, 0); }
			100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(247, 181, 48, 0); }
		}

		.user-location-icon {
			width: 14px;
			height: 14px;
			background-color: var(--color-secondary);
			border-radius: 50%;
			border: 2px solid white;
			box-shadow: 0 0 10px var(--color-secondary);
		}
		
		.satellite-label {
			background-color: rgba(13, 17, 23, 0.8);
			color: var(--color-text-primary);
			border: 1px solid var(--color-orbit);
			border-radius: 6px;
			padding: 3px 8px;
			font-size: 12px;
			font-weight: 500;
			white-space: nowrap;
			box-shadow: 0 0 10px rgba(0,0,0,0.5);
		}

		/* INICIO MODIFICACIÓN: Estilo para que el nombre del satélite sea clickeable */
		#satellite-name-display {
			cursor: pointer;
			transition: color 0.2s ease-in-out;
		}
		#satellite-name-display:hover {
			color: var(--color-secondary);
		}
		/* FIN MODIFICACIÓN */

		/* INICIO CORRECCIÓN: Animación suave para el botón de información */
		#satellite-info-btn {
			opacity: 0;
			transform: scale(0.8);
			transform-origin: left center; /* Para que la escala se origine desde el lado del texto */
			transition: opacity 0.3s ease-in-out 0.1s, transform 0.3s ease-in-out 0.1s;
			pointer-events: none; /* Previene clicks cuando está oculto */
		}
		#main-control-panel.expanded #satellite-info-btn {
			opacity: 1;
			transform: scale(1);
			pointer-events: auto;
		}
		/* FIN CORRECCIÓN */

		.orbit-path {
			stroke: var(--color-orbit);
			stroke-width: 2.5;
			stroke-opacity: 0.8;
			fill: none;
			filter: drop-shadow(0 0 5px var(--color-orbit));
		}
		
		.orbit-path-shadow {
			stroke: var(--color-text-secondary);
			stroke-width: 2;
			stroke-opacity: 0.7;
			stroke-dasharray: 4, 4;
			fill: none;
		}
		
		#main-control-panel {
			position: absolute;
			z-index: 500;
			top: 1rem;
			left: 1rem;
			right: 1rem;
			max-width: 1000px;
			margin-left: auto;
			margin-right: auto;
			background: rgba(22, 27, 34, 0.8);
			backdrop-filter: blur(8px);
			border: 1px solid #30363d;
			box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border-radius: 12px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            max-height: 58px; /* Altura del panel colapsado */
		}
        #main-control-panel.expanded {
            max-height: 500px; /* Altura máxima al expandir */
        }
        
        #collapsed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            height: 58px;
        }

        #expanded-content {
            padding: 0 1rem 1rem 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out 0.1s;
        }
        #main-control-panel.expanded #expanded-content {
            opacity: 1;
        }
        
        #toggle-menu-btn .fa-chevron-down {
            transition: transform 0.3s ease-in-out;
        }
        #main-control-panel.expanded #toggle-menu-btn .fa-chevron-down {
            transform: rotate(180deg);
        }

        .status-badge {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            background-color: var(--color-surface);
            border: 1px solid #30363d;
        }
        
		#toggle-time-control-btn {
            position: absolute;
            z-index: 450;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            height: auto;
            width: auto;
            padding: 0.5rem 1rem;
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid #30363d;
            border-radius: 9999px;
            color: var(--color-text-primary);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        #toggle-time-control-btn:hover {
            border-color: var(--color-secondary);
            color: var(--color-secondary);
            transform: translateX(-50%) scale(1.05);
        }

		#time-control-panel {
			position: absolute;
			z-index: 500;
			background: rgba(22, 27, 34, 0.8);
			backdrop-filter: blur(8px);
			border: 1px solid #30363d;
			box-shadow: 0 4px 20px rgba(0,0,0,0.4);
			bottom: 4.5rem;
			left: 1rem;
			right: 1rem;
			max-width: 1000px;
			margin-left: auto;
			margin-right: auto;
			border-radius: 12px;
			padding: 1rem 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
        }
        #time-control-panel.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
		
        #timeline-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; 
            height: 12px;
            background: #30363d;
            outline: none; 
            border-radius: 6px;
        }
        #timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px;
            height: 24px;
            background: var(--color-secondary);
            cursor: pointer; border-radius: 50%; 
            border: 3px solid var(--color-background);
        }
        #timeline-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--color-secondary);
            cursor: pointer; 
            border-radius: 50%; 
            border: 3px solid var(--color-background);
        }

        .time-traveling-active {
            color: var(--color-warning) !important;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
		
		#map-style-switcher {
			position: absolute;
			z-index: 500;
			bottom: 1.5rem;
			left: 1rem;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}
		#map-style-options {
			background: rgba(22, 27, 34, 0.8);
			backdrop-filter: blur(8px);
			border: 1px solid #30363d;
			border-radius: 8px;
			padding: 0.5rem;
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
			box-shadow: 0 4px 20px rgba(0,0,0,0.4);
			opacity: 0;
			transform: translateY(10px);
			transition: opacity 0.2s ease, transform 0.2s ease;
			pointer-events: none;
		}
		#map-style-switcher.is-open #map-style-options {
			opacity: 1;
			transform: translateY(0);
			pointer-events: auto;
		}
		.map-style-btn {
			width: 100%;
			text-align: left;
			padding: 0.5rem 1rem;
			border-radius: 6px;
			font-weight: 500;
			color: var(--color-text-primary);
			transition: background-color 0.2s ease;
		}
		.map-style-btn:hover {
			background-color: rgba(255, 255, 255, 0.1);
		}
		.map-style-btn.active {
			background-color: var(--color-primary);
			color: white;
		}

		#visibility-legend .fa-circle {
			font-size: 0.6em;
			vertical-align: middle;
			margin-right: 0.5rem;
		}
		#toggle-visibility-bands-btn.active {
			background-color: var(--color-accent);
			border-color: var(--color-secondary);
			color: white;
		}

	</style>
</head>
<body class="antialiased">
	
	<!-- ==========================================================================
	   PANTALLA DE INICIO
	   ========================================================================== -->
	<div id="start-screen" class="screen">
		<div class="text-center">
			<i class="fa-solid fa-satellite-dish text-6xl text-primary mb-4 animate-pulse"></i>
			<h1 class="text-5xl font-bold mb-2">SatélitesArg</h1>
			<p class="text-xl text-text-secondary mb-8">Tu visualizador satelital en tiempo real.</p>
			<div class="flex flex-col md:flex-row gap-4 justify-center">
				<button id="open-map-btn" class="btn btn-secondary text-lg">
					<i class="fa-solid fa-map-location-dot mr-2"></i> Abrir Mapa
				</button>
				<button id="open-known-satellites-btn" class="btn btn-secondary text-lg">
					<i class="fa-solid fa-star mr-2"></i> Satélites
				</button>
			</div>
		</div>
	</div>

	<!-- ==========================================================================
	   PANTALLA DE SATÉLITES CONOCIDOS
	   ========================================================================== -->
	<div id="known-satellites-screen" class="screen hidden">
		<div class="text-center w-full max-w-2xl">
			<h2 class="text-4xl font-bold mb-6">Satélites</h2>
			<p class="text-text-secondary mb-8">Selecciona un satélite, guárdalo en tus favoritos o gestiona tu propia lista.</p>
			
			<div id="known-satellites-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<button id="open-my-satellites-btn" class="btn btn-primary text-left p-4 md:col-span-2">
                    <span class="text-lg font-bold block"><i class="fa-solid fa-user-astronaut mr-3"></i>Mis Satélites Guardados</span>
                    <span class="text-sm block ml-8">Agrega y rastrea tus propios satélites desde TLE o favoritos.</span>
                </button>
				<!-- Los satélites conocidos se insertarán aquí dinámicamente -->
			</div>

			<button id="back-to-start-btn" class="btn btn-secondary mt-12">
				<i class="fa-solid fa-arrow-left mr-2"></i> Volver al Inicio
			</button>
		</div>
	</div>

	<!-- ==========================================================================
	   PANTALLA DE MIS SATÉLITES
	   ========================================================================== -->
    <div id="my-satellites-screen" class="screen hidden">
		<div class="text-center w-full max-w-3xl">
			<h2 class="text-4xl font-bold mb-6">Mis Satélites Guardados</h2>
			<p class="text-text-secondary mb-8">Aquí puedes ver, rastrear o eliminar los satélites que has agregado.</p>
            
            <div id="my-satellites-list" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
                <!-- Los satélites guardados se insertarán aquí -->
            </div>

            <p id="no-my-satellites-msg" class="text-text-secondary p-8 border-2 border-dashed border-gray-700 rounded-lg hidden">
                Aún no has guardado ningún satélite.
            </p>

			<div class="flex flex-col md:flex-row gap-4 justify-center mt-12">
				<button id="add-my-satellite-btn" class="btn btn-primary">
                    <i class="fa-solid fa-plus mr-2"></i> Agregar Nuevo Satélite (TLE)
                </button>
                <button id="back-to-known-btn" class="btn btn-secondary">
				    <i class="fa-solid fa-arrow-left mr-2"></i> Volver
			    </button>
			</div>
		</div>
	</div>

	<!-- ==========================================================================
	   CONTENEDOR PRINCIPAL DE LA APP (MAPA)
	   ========================================================================== -->
	<div id="app-container" class="w-full h-screen relative hidden">
		<div id="map-container">
			<div id="map"></div>
		</div>
		
		<header id="main-control-panel">
            <div id="collapsed-header" class="relative">
                <div class="flex items-center gap-4">
                    <button id="back-to-start-from-map-btn" class="btn btn-secondary !p-2 h-9 w-9 flex-shrink-0 flex items-center justify-center" aria-label="Volver al inicio" title="Volver al inicio">
						<i class="fa-solid fa-house"></i>
					</button>
                    <h2 class="font-bold text-lg hidden sm:block">SatélitesArg</h2>
                </div>
                <!-- INICIO CORRECCIÓN: Estructura modificada para centrar el texto del satélite independientemente del botón de información -->
                <div id="satellite-info-header" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center font-mono text-sm hidden">
					<span id="satellite-name-display" class="font-bold text-white truncate max-w-[200px]" title="Centrar en el satélite"></span>
					<!-- El botón ahora está posicionado de forma absoluta para no afectar el centrado del texto -->
					<button id="satellite-info-btn" class="absolute left-full ml-2 text-secondary hover:text-primary transition-colors" title="Ver información del satélite">
						<i class="fa-solid fa-circle-info text-lg"></i>
					</button>
				</div>
                <!-- FIN CORRECCIÓN -->
                <button id="toggle-menu-btn" class="btn btn-secondary !p-2 h-9 w-9 flex-shrink-0 flex items-center justify-center" aria-label="Expandir o colapsar menú" title="Expandir/Colapsar Menú">
					<i class="fa-solid fa-chevron-down"></i>
				</button>
            </div>
            
            <div id="expanded-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center py-4">
                    <div class="flex flex-col items-center md:col-span-1">
                          <div class="relative w-full">
                              <input type="text" id="location-input" class="input-field pl-8" placeholder="Escribe tu ciudad...">
                              <i class="fa-solid fa-location-crosshairs absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                          </div>
                          <div id="location-feedback" class="text-xs text-center mt-1 h-4"></div>
                          <div id="tle-status" class="text-xs text-center text-gray-400 mt-1">No hay datos cargados.</div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="open-favorites-modal-btn" class="btn btn-primary flex items-center justify-center">
                            <i class="fa-solid fa-star mr-2"></i> Satélite
                        </button>
                        <button id="predict-passes-btn" class="btn btn-primary flex items-center justify-center" disabled>
                             <i class="fa-solid fa-forward mr-2"></i> Predecir
                        </button>
                    </div>
                </div>
            </div>
		</header>
		  
        <div id="time-control-panel">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between mb-2">
                     <span class="font-mono text-sm text-text-secondary uppercase tracking-wider">Control de Simulación</span>
                     <button id="reset-time-btn" class="btn btn-secondary !px-3 !py-1 text-xs" title="Volver al tiempo actual">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i>TIEMPO REAL
                     </button>
                </div>
        
                <div class="w-full py-2">
                    <input type="range" min="0" max="1439" value="0" class="w-full" id="timeline-slider" title="Arrastra para cambiar la hora del día">
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                    <div class="flex items-center gap-2 justify-center md:justify-start">
                        <input type="date" id="date-input" class="input-field !p-2 text-sm bg-transparent w-full max-w-[150px]" aria-label="Seleccionar fecha">
                        <input type="time" id="time-input" class="input-field !p-2 text-sm bg-transparent w-full max-w-[110px]" step="60" aria-label="Seleccionar hora">
                    </div>
        
                    <div class="flex items-center justify-center p-1 rounded-full bg-black/20 order-first md:order-none">
                        <button id="time-rewind-btn" class="btn btn-secondary !p-0 h-10 w-10 flex items-center justify-center !border-none rounded-full" title="Retroceder en el tiempo"><i class="fa-solid fa-backward-fast"></i></button>
                        <button id="time-step-btn" class="btn btn-secondary !border-none !bg-transparent w-20 font-bold text-base" title="Cambiar unidad de tiempo (Segundos/Minutos/Horas)">MIN</button>
                        <button id="time-forward-btn" class="btn btn-secondary !p-0 h-10 w-10 flex items-center justify-center !border-none rounded-full" title="Avanzar en el tiempo"><i class="fa-solid fa-forward-fast"></i></button>
                    </div>
                    
                    <div class="hidden md:flex"></div>
                </div>
            </div>
        </div>
        
        <button id="toggle-time-control-btn" title="Controles de tiempo" aria-label="Mostrar controles de tiempo" class="font-mono">
             <span id="utc-time-display">UTC: --:--:--</span>
        </button>

		<div id="map-style-switcher">
			<div id="map-style-options">
				<button class="map-style-btn active" data-layer="dark">Oscuro</button>
				<button class="map-style-btn" data-layer="light">Claro</button>
				<button class="map-style-btn" data-layer="satellite">Satélite</button>
			</div>
			<button id="map-style-toggle-btn" class="btn btn-secondary !p-0 h-11 w-11 flex items-center justify-center" title="Cambiar estilo del mapa">
				<i class="fa-solid fa-layer-group text-lg"></i>
			</button>
		</div>

		<div id="action-controls" class="absolute z-[500] bottom-6 right-4 flex gap-2">
			<button id="toggle-visibility-bands-btn" class="btn btn-secondary !p-0 h-11 w-11 flex items-center justify-center hidden" title="Mostrar/Ocultar bandas de visibilidad">
				<i class="fa-solid fa-eye text-lg"></i>
			</button>
		</div>

		<!-- Contenedor solo para la leyenda -->
		<div id="visibility-controls" class="absolute z-[450] bottom-[5.5rem] right-4 flex-col items-end gap-2 hidden">
			<div id="visibility-legend" class="text-xs text-right bg-surface/80 p-2 rounded-md border border-gray-700 backdrop-blur-sm shadow-lg hidden">
				<div><i class="fa-solid fa-circle" style="color:rgba(57, 211, 83, 0.25)"></i> Óptima (> 60°)</div>
				<div><i class="fa-solid fa-circle" style="color:rgba(247, 181, 48, 0.2)"></i> Media (30°-60°)</div>
				<div><i class="fa-solid fa-circle" style="color:rgba(248, 81, 73, 0.15)"></i> Periférica (10°-30°)</div>
			</div>
		</div>

	</div>

	<!-- ==========================================================================
	   MODALES
	   ========================================================================== -->
	<div id="tle-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<h3>Agregar Nuevo Satélite (Formato TLE)</h3>
			<p class="text-sm text-gray-400 mb-4">
				Pega aquí los datos TLE del satélite. Puedes encontrarlos en sitios como <a href="https://celestrak.org/" target="_blank" class="text-blue-400 hover:underline">CelesTrak</a>. El nombre se tomará de la primera línea.
			</p>
			<textarea id="tle-input" rows="5" class="textarea-field w-full text-sm font-mono" placeholder="MI SATÉLITE PERSONALIZADO&#10;1 51092U 22002AS...&#10;2 51092 53.2173..."></textarea>
			<div class="flex justify-end gap-4 mt-6">
				<button id="close-tle-modal-btn" class="btn btn-secondary">Cancelar</button>
				<button id="save-tle-btn" class="btn btn-primary">Guardar Satélite</button>
			</div>
		</div>
	</div>
	
	<div id="passes-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<h3 id="passes-modal-title">Próximos Pasos Visibles</h3>
			<div id="results-container">
				</div>
			<div class="flex justify-center mt-6">
				<button id="close-passes-modal-btn" class="btn btn-primary">Cerrar</button>
			</div>
		</div>
	</div>

    <div id="confirm-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<h3>Confirmar Eliminación</h3>
			<p id="confirm-modal-text" class="text-text-secondary mb-6">
                ¿Estás seguro de que deseas eliminar este satélite?
            </p>
			<div class="flex justify-end gap-4">
				<button id="cancel-delete-btn" class="btn btn-secondary">Cancelar</button>
				<button id="confirm-delete-btn" class="btn btn-danger">Eliminar</button>
			</div>
		</div>
	</div>

    <div id="favorites-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<h3>Seleccionar Satélite Favorito</h3>
            <div id="favorites-modal-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2 mt-4">
                <!-- La lista de satélites favoritos se insertará aquí -->
            </div>
			<div class="flex justify-center mt-6">
				<button id="close-favorites-modal-btn" class="btn btn-secondary">Cerrar</button>
			</div>
		</div>
	</div>

	<div id="satellite-info-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<h3 id="satellite-info-modal-title">Información del Satélite</h3>
			<div id="satellite-info-content" class="space-y-4 text-text-secondary">
				<!-- La información se insertará aquí dinámicamente -->
			</div>
			<div class="flex justify-center mt-6">
				<button id="close-satellite-info-modal-btn" class="btn btn-primary">Cerrar</button>
			</div>
		</div>
	</div>

	<!-- ==========================================================================
	   LÓGICA DE LA APLICACIÓN (JAVASCRIPT)
	   ========================================================================== -->
	<script>
		function calculateDestinationPoint(lat, lon, bearing, distance) {
			const R = 6371; // Radio de la Tierra en km
			const latRad = satellite.degreesToRadians(lat);
			const lonRad = satellite.degreesToRadians(lon);
			const bearingRad = satellite.degreesToRadians(bearing);

			const lat2Rad = Math.asin(Math.sin(latRad) * Math.cos(distance / R) +
							Math.cos(latRad) * Math.sin(distance / R) * Math.cos(bearingRad));
			
			const lon2Rad = lonRad + Math.atan2(Math.sin(bearingRad) * Math.sin(distance / R) * Math.cos(latRad),
										Math.cos(distance / R) - Math.sin(latRad) * Math.sin(lat2Rad));

			return [satellite.radiansToDegrees(lat2Rad), satellite.radiansToDegrees(lon2Rad)];
		}

		function calculateBearing(p1, p2) {
			const [lat1, lon1] = p1;
			const [lat2, lon2] = p2;
			const lat1Rad = satellite.degreesToRadians(lat1);
			const lon1Rad = satellite.degreesToRadians(lon1);
			const lat2Rad = satellite.degreesToRadians(lat2);
			const lon2Rad = satellite.degreesToRadians(lon2);

			const y = Math.sin(lon2Rad - lon1Rad) * Math.cos(lat2Rad);
			const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
					Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(lon2Rad - lon1Rad);
			const bearingRad = Math.atan2(y, x);
			return (satellite.radiansToDegrees(bearingRad) + 360) % 360;
		}

		document.addEventListener('DOMContentLoaded', () => {
			const App = {
				// -------------------------------------------------------------------
				//  APPLICATION STATE AND CONFIGURATION
				// -------------------------------------------------------------------
				state: {
					audioInitialized: false,
					mapInitialized: false,
					trackedSatellites: [],
					observerCoords: null, // [lat, lon]
					userLocationMarker: null,
					map: null,
					sounds: {},
					realTimeInterval: null,
					geocodeTimeout: null,
					currentTime: new Date(),
					isTimeTraveling: false,
					isPassViewActive: false,
					timeStepIndex: 1, // 0: sec, 1: min, 2: hr
					baseLayers: {},
					currentBaseLayer: null,
					visibilityBands: { 
						layers: [], 
						visible: false, 
						trajectory: [] 
					},
				},

				config: {
					timeSteps: [
						{ unit: 'seconds', label: 'SEG', value: 1000 },
						{ unit: 'minutes', label: 'MIN', value: 60000 },
						{ unit: 'hours', label: 'HS', value: 3600000 },
					],
					knownSatellites: {
						'iss': { name: 'Estación Espacial (ISS)', noradId: 25544, tle: null, icon: 'fa-igloo', description: 'El laboratorio orbital más grande.' },
						'tiangong': { name: 'Estación Espacial (Tiangong)', noradId: 48274, tle: null, icon: 'fa-building-columns', description: 'Estación espacial modular de China.' },
						'hubble': { name: 'Telescopio Espacial Hubble', noradId: 20580, tle: null, icon: 'fa-satellite', description: 'Observatorio espacial icónico.' }
					},
                    localStorageKey: 'satelitesarg_my_satellites',
                    locationStorageKey: 'satelitesarg_user_location',
				},

				elements: {},

				// -------------------------------------------------------------------
				//  INITIALIZATION
				// -------------------------------------------------------------------
				init() {
					this.cacheDOMElements();
					this.initAudio();
                    this.location.loadFromStorage();
					this.setupEventListeners();
                    this.mySatellites.renderKnownSatellitesList();
					this.satellites.updateTlesFromSource();
					this.ui.updateButtonsState();
					this.ui.showScreen('start-screen');
					this.mapLayers.init();
				},

				cacheDOMElements() {
					const ids = [
						'start-screen', 'known-satellites-screen', 'app-container',
						'open-known-satellites-btn', 'open-map-btn', 'back-to-start-btn',
						'back-to-start-from-map-btn', 'tle-modal',
						'close-tle-modal-btn', 'save-tle-btn', 'tle-input', 'tle-status',
						'location-input', 'location-feedback', 'predict-passes-btn',
						'passes-modal', 'passes-modal-title', 'close-passes-modal-btn',
						'results-container', 'main-control-panel', 'collapsed-header', 'expanded-content',
						'toggle-menu-btn', 'utc-time-display',
						'time-control-panel', 'toggle-time-control-btn', 'reset-time-btn',
						'time-rewind-btn', 'time-step-btn', 'time-forward-btn',
						'timeline-slider', 'date-input', 'time-input', 'current-time-display',
                        'my-satellites-screen', 'open-my-satellites-btn', 'my-satellites-list',
                        'no-my-satellites-msg', 'add-my-satellite-btn', 'back-to-known-btn',
                        'known-satellites-list', 'confirm-modal', 'confirm-modal-text',
                        'confirm-delete-btn', 'cancel-delete-btn',
                        'open-favorites-modal-btn', 'favorites-modal', 'close-favorites-modal-btn',
                        'favorites-modal-list',
						'map-style-switcher', 'map-style-toggle-btn', 'map-style-options',
						'action-controls', 
						'visibility-controls', 'toggle-visibility-bands-btn', 'visibility-legend',
						'satellite-info-header', 'satellite-name-display', 'satellite-info-btn',
						'satellite-info-modal', 'satellite-info-modal-title', 'satellite-info-content',
						'close-satellite-info-modal-btn'
					];
					ids.forEach(id => {
						const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
						this.elements[camelCaseId] = document.getElementById(id);
					});
				},

				initMap() {
					if (this.state.mapInitialized) return;
					// ==================================================================
					// INICIO DE LA MODIFICACIÓN: ZOOM FLUIDO Y SIN PARPADEOS
					// ==================================================================
					// La animación se activa para prevenir parpadeos, pero el CSS la
					// hace casi instantánea para que el control sea súper responsivo.
					this.state.map = L.map('map', { 
						zoomControl: false, 
						attributionControl: false,
						maxBounds: [[-90, -540], [90, 540]],
                        minZoom: 2,
						zoomSnap: 0.1,
						zoomDelta: 0.25,
						zoomAnimation: true // <-- Se mantiene en `true` para que el CSS funcione
					}).setView([20, 0], 2);
					// ==================================================================
					// FIN DE LA MODIFICACIÓN
					// ==================================================================

					this.mapLayers.defineLayers();
					this.mapLayers.switchLayer('dark');

					this.state.mapInitialized = true;
				},

				async initAudio() {
					if (this.state.audioInitialized) return;
					try {
						await Tone.start();
						const mainVolume = new Tone.Volume(-12).toDestination();
						this.state.sounds = {
							uiClick: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 } }).connect(mainVolume),
							success: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }, volume: -10 }).connect(mainVolume),
							error: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, volume: -10 }).connect(mainVolume),
                            trash: new Tone.Synth({ oscillator: { type: 'noise' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }, volume: -15 }).connect(mainVolume)
						};
						this.state.audioInitialized = true;
					} catch(e) { console.error("Could not initialize audio:", e); }
				},

				setupEventListeners() {
					const { elements } = this;
					
					elements.openMapBtn.addEventListener('click', () => { this.playSound('uiClick', 'C4'); this.ui.showScreen('app-container'); });
					elements.openKnownSatellitesBtn.addEventListener('click', () => { this.playSound('uiClick', 'D4'); this.ui.showScreen('known-satellites-screen'); });
					elements.backToStartBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.showScreen('start-screen'); });
					
                    elements.backToStartFromMapBtn.addEventListener('click', () => {
						this.playSound('uiClick', 'A3');
						this.satellites.clearAll();

						if (this.state.map) {
							this.state.map.remove();
							this.state.map = null;
							this.state.mapInitialized = false;
						}

						this.ui.showScreen('start-screen');
					});
					
                    elements.openMySatellitesBtn.addEventListener('click', () => { this.playSound('uiClick', 'E4'); this.mySatellites.showScreen(); });
                    elements.backToKnownBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.showScreen('known-satellites-screen'); });
                    elements.addMySatelliteBtn.addEventListener('click', () => { this.playSound('uiClick', 'C4'); this.elements.tleInput.value = ''; this.ui.showModal(elements.tleModal); });
                    elements.saveTleBtn.addEventListener('click', () => this.mySatellites.handleSaveTle());

					elements.closeTleModalBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.hideModal(elements.tleModal); });

                    elements.cancelDeleteBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.hideModal(elements.confirmModal); });
                    elements.confirmDeleteBtn.addEventListener('click', (e) => this.mySatellites.confirmDelete(e));

					elements.locationInput.addEventListener('input', () => {
						clearTimeout(this.state.geocodeTimeout);
						this.state.geocodeTimeout = setTimeout(() => this.location.handleCitySearch(), 500);
					});

					elements.locationInput.addEventListener('keydown', (event) => {
						if (event.key === 'Enter') {
							event.preventDefault();
							clearTimeout(this.state.geocodeTimeout);
							this.location.handleCitySearch();
							elements.locationInput.blur();
						}
					});
                    
                    elements.openFavoritesModalBtn.addEventListener('click', () => {
                        this.playSound('uiClick', 'D4');
                        this.mySatellites.renderFavoritesForSelection();
                        this.ui.showModal(this.elements.favoritesModal);
                    });
                    elements.closeFavoritesModalBtn.addEventListener('click', () => {
                        this.playSound('uiClick', 'A3');
                        this.ui.hideModal(this.elements.favoritesModal);
                    });

					elements.predictPassesBtn.addEventListener('click', () => this.prediction.handlePrediction());
					elements.closePassesModalBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.hideModal(elements.passesModal); });

					elements.satelliteNameDisplay.addEventListener('click', () => {
						if (this.state.trackedSatellites.length > 0 && this.state.map) {
							const sat = this.state.trackedSatellites[0];
							if (sat.marker) {
								this.playSound('uiClick', 'F4');
								this.state.map.panTo(sat.marker.getLatLng());
							}
						}
					});

					elements.satelliteInfoBtn.addEventListener('click', () => this.satellites.showInfoModal());
					elements.closeSatelliteInfoModalBtn.addEventListener('click', () => { this.playSound('uiClick', 'A3'); this.ui.hideModal(elements.satelliteInfoModal); });

					elements.toggleMenuBtn.addEventListener('click', (e) => { 
						e.stopPropagation();
						elements.mainControlPanel.classList.toggle('expanded');
					});
					
					let isDragging = false, startY = 0, initialMaxHeight = 0, expandedHeight = 0;
					const panel = elements.mainControlPanel;
					const expandedContent = elements.expandedContent;
					const collapsedHeight = 58;
					
					const startDrag = (e) => {
						if (e.target.closest('button, input')) return;
						expandedHeight = expandedContent.scrollHeight + collapsedHeight; 
						isDragging = true;
						startY = e.pageY || e.touches[0].pageY;
						initialMaxHeight = panel.offsetHeight;
						panel.style.transition = 'none';
						expandedContent.style.transition = 'none';
						document.body.style.cursor = 'ns-resize';
					};

					const onDrag = (e) => {
						if (!isDragging) return;
						e.preventDefault();
						const currentY = e.pageY || e.touches[0].pageY;
						const deltaY = currentY - startY;
						let newMaxHeight = Math.max(collapsedHeight, Math.min(initialMaxHeight + deltaY, expandedHeight));
						panel.style.maxHeight = `${newMaxHeight}px`;

						const expansionProgress = (newMaxHeight - collapsedHeight) / (expandedHeight * 0.75 - collapsedHeight);
						expandedContent.style.opacity = Math.max(0, Math.min(1, expansionProgress));
					};

					const endDrag = () => {
						if (!isDragging) return;
						isDragging = false;
						document.body.style.cursor = 'default';
						panel.style.transition = '';
						expandedContent.style.transition = '';
						expandedContent.style.opacity = '';

						const shouldBeExpanded = panel.offsetHeight > collapsedHeight * 1.5;
						panel.classList.toggle('expanded', shouldBeExpanded);
						panel.style.maxHeight = '';
					};

					panel.addEventListener('mousedown', startDrag);
					document.addEventListener('mousemove', onDrag);
					document.addEventListener('mouseup', endDrag);
					panel.addEventListener('touchstart', startDrag, { passive: false });
					document.addEventListener('touchmove', onDrag, { passive: false });
					document.addEventListener('touchend', endDrag);
					
					elements.toggleTimeControlBtn.addEventListener('click', () => {
						this.playSound('uiClick', 'C4'); 
						elements.timeControlPanel.classList.toggle('visible');
						
						if (this.state.map) {
							if (elements.timeControlPanel.classList.contains('visible')) {
								// INICIO CORRECCIÓN: Movimiento invertido
								// El menú se abre -> el mapa se mueve hacia ABAJO para hacer espacio.
								this.state.map.panBy([0, 100], { animate: true });
							} else {
								// El menú se cierra -> el mapa vuelve a su lugar (hacia ARRIBA).
								this.state.map.panBy([0, -100], { animate: true });
							}
						}
					});

					elements.resetTimeBtn.addEventListener('click', () => { this.playSound('uiClick', 'G4'); this.time.stopTimeTravel(); this.time.startRealTimeUpdates(); });
					elements.timeStepBtn.addEventListener('click', () => {
						this.playSound('uiClick', 'E4');
						this.state.timeStepIndex = (this.state.timeStepIndex + 1) % this.config.timeSteps.length;
						elements.timeStepBtn.textContent = this.config.timeSteps[this.state.timeStepIndex].label;
					});
					elements.timeRewindBtn.addEventListener('click', () => this.time.adjustTime(-1));
					elements.timeForwardBtn.addEventListener('click', () => this.time.adjustTime(1));
					elements.dateInput.addEventListener('change', () => this.time.setTimeFromInputs());
					elements.timeInput.addEventListener('change', () => this.time.setTimeFromInputs());
					elements.timelineSlider.addEventListener('input', () => this.time.setTimeFromSlider());
					
					elements.toggleVisibilityBandsBtn.addEventListener('click', () => this.prediction.toggleVisibilityBands());
				},

				playSound(soundKey, note) {
					if (!this.state.audioInitialized || !this.state.sounds[soundKey]) return;
					try {
                        if(soundKey === 'trash') this.state.sounds.trash.triggerAttackRelease('8n');
						else this.state.sounds[soundKey].triggerAttackRelease(note || 'C4', '8n');
					} catch(e) { console.error(`Error playing sound ${soundKey}:`, e); }
				},

				ui: {
					showScreen(screenId) {
						const { startScreen, knownSatellitesScreen, appContainer, mySatellitesScreen } = App.elements;
						[startScreen, knownSatellitesScreen, appContainer, mySatellitesScreen].forEach(s => s.classList.add('hidden'));
						const targetScreen = document.getElementById(screenId);
						if(targetScreen) targetScreen.classList.remove('hidden');

						if (screenId === 'app-container') {
							App.elements.mainControlPanel.classList.remove('expanded');
							App.elements.timeControlPanel.classList.remove('visible');
                            if (!App.state.mapInitialized) App.initMap();
                            App.location.applySavedLocationToMap();
                        } else if (screenId === 'known-satellites-screen') {
                            App.mySatellites.updateFavoriteIcons();
                        }
					},
					
					updateButtonsState() {
						const { openFavoritesModalBtn, predictPassesBtn } = App.elements;
						const hasTle = App.state.trackedSatellites.length > 0;
						const hasLocation = App.state.observerCoords !== null;
                        const hasFavorites = App.mySatellites.loadFromStorage().length > 0;
						
                        openFavoritesModalBtn.disabled = !hasFavorites;
						predictPassesBtn.disabled = !hasTle || !hasLocation;
					},

					showModal(modalElement) {
						modalElement.classList.remove('hidden');
						setTimeout(() => modalElement.classList.add('is-visible'), 10);
					},

					hideModal(modalElement) {
						modalElement.classList.remove('is-visible');
						setTimeout(() => modalElement.classList.add('hidden'), 300);
					},
				},

				mapLayers: {
					init() {
						const { mapStyleToggleBtn, mapStyleOptions } = App.elements;

						mapStyleToggleBtn.addEventListener('click', () => {
							App.playSound('uiClick', 'D4');
							App.elements.mapStyleSwitcher.classList.toggle('is-open');
						});

						mapStyleOptions.addEventListener('click', (e) => {
							const button = e.target.closest('.map-style-btn');
							if (button) {
								const layerId = button.dataset.layer;
								this.switchLayer(layerId);
								App.playSound('uiClick', 'C4');
								App.elements.mapStyleSwitcher.classList.remove('is-open');
							}
						});
					},

					defineLayers() {
						App.state.baseLayers = {
							dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
								attribution: '&copy; CARTO',
								subdomains: 'abcd', maxZoom: 20
							}),
							light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
								attribution: '&copy; CARTO',
								subdomains: 'abcd', maxZoom: 20
							}),
							satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
								attribution: 'Tiles &copy; Esri',
								maxZoom: 19
							}),
						};
					},

					switchLayer(layerId) {
						if (!App.state.map || !App.state.baseLayers[layerId]) return;

						if (App.state.currentBaseLayer) {
							App.state.map.removeLayer(App.state.currentBaseLayer);
						}
						
						App.state.currentBaseLayer = App.state.baseLayers[layerId];
						App.state.map.addLayer(App.state.currentBaseLayer);

						const tilePane = App.state.map.getPane('tilePane');
						tilePane.className = 'leaflet-tile-pane'; // Reset
						if (layerId === 'light') {
							tilePane.classList.add('light-map');
						} else if (layerId === 'satellite') {
							tilePane.classList.add('satellite-map');
						}

						App.elements.mapStyleOptions.querySelectorAll('.map-style-btn').forEach(btn => {
							btn.classList.toggle('active', btn.dataset.layer === layerId);
						});
					}
				},
                
                mySatellites: {
                    showScreen() { App.ui.showScreen('my-satellites-screen'); this.renderList(); },
                    renderKnownSatellitesList() {
                        const container = App.elements.knownSatellitesList;
                        container.querySelectorAll('.known-satellite-item').forEach(item => item.remove());

                        Object.entries(App.config.knownSatellites).forEach(([id, sat]) => {
                            const satElement = document.createElement('div');
							satElement.className = 'known-satellite-item btn btn-secondary text-left p-4 flex justify-between items-center is-loading';
                            satElement.id = `known-sat-${id}`;
                            satElement.innerHTML = `
                                <div class="flex-grow cursor-pointer known-satellite-btn" data-sat-id="${id}">
                                    <span class="text-lg font-bold block"><i class="fa-solid ${sat.icon || 'fa-satellite-dish'} mr-3 text-secondary"></i>${sat.name}</span>
                                    <div class="sat-status-indicator ml-8 text-sm text-text-secondary">Cargando TLE... <i class="fa-solid fa-spinner fa-spin ml-2"></i></div>
                                </div>
                                <button class="btn !p-0 h-9 w-9 flex-shrink-0 flex items-center justify-center favorite-btn" data-sat-id="${id}" title="Guardar en Mis Satélites"><i class="fa-regular fa-heart text-xl"></i></button>`;
                            container.appendChild(satElement);
                        });
                        
                        container.querySelectorAll('.known-satellite-btn').forEach(btn => btn.addEventListener('click', (e) => App.satellites.loadKnown(e.currentTarget.dataset.satId)));
                        container.querySelectorAll('.favorite-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); this.handleFavoriteClick(e.currentTarget.dataset.satId, e.currentTarget); }));
                        this.updateFavoriteIcons();
                    },
                    updateFavoriteIcons() {
                        const mySats = this.loadFromStorage(), favoriteSatNames = mySats.map(s => s.name);
                        App.elements.knownSatellitesList.querySelectorAll('.favorite-btn').forEach(btn => {
                            const satId = btn.dataset.satId, satInfo = App.config.knownSatellites[satId], heartIcon = btn.querySelector('i');
                            const isFav = favoriteSatNames.includes(satInfo.name);
                            btn.classList.toggle('is-favorite', isFav);
                            heartIcon.classList.toggle('fa-regular', !isFav); heartIcon.classList.toggle('fa-solid', isFav);
                        });
                    },
                    handleFavoriteClick(satId, buttonElement) {
                        const satData = App.config.knownSatellites[satId];
                        if (!satData || !satData.tle) { App.playSound('error', 'C3'); return; };
                        let mySats = this.loadFromStorage();
                        const existingIndex = mySats.findIndex(s => s.name === satData.name);
                        if (existingIndex > -1) { mySats.splice(existingIndex, 1); App.playSound('trash'); } 
                        else { mySats.push({ name: satData.name, tle: satData.tle }); App.playSound('success', 'A4'); }
                        this.saveToStorage(mySats); this.updateFavoriteIcons(); App.ui.updateButtonsState();
                    },
                    renderFavoritesForSelection() {
                        const container = App.elements.favoritesModalList;
                        const mySats = this.loadFromStorage();
                        container.innerHTML = mySats.length === 0 ? `<p class="text-text-secondary text-center p-4">No tienes satélites guardados.</p>` : '';
                        mySats.forEach(sat => {
                            const satButton = document.createElement('button');
                            satButton.className = 'btn btn-secondary text-left p-3 w-full';
                            satButton.dataset.tle = sat.tle;
                            satButton.innerHTML = `<span class="font-bold block text-base"><i class="fa-solid fa-satellite-dish mr-3 text-secondary"></i>${sat.name}</span>`;
                            satButton.addEventListener('click', (e) => { this.handleTrack(e.currentTarget.dataset.tle); App.ui.hideModal(App.elements.favoritesModal); });
                            container.appendChild(satButton);
                        });
                    },
                    renderList() {
                        const { mySatellitesList, noMySatellitesMsg } = App.elements;
                        const mySats = this.loadFromStorage();
                        mySatellitesList.innerHTML = '';
                        noMySatellitesMsg.classList.toggle('hidden', mySats.length > 0);
                        mySatellitesList.classList.toggle('hidden', mySats.length === 0);
                        mySats.forEach((sat, index) => {
                            const satElement = document.createElement('div');
                            satElement.className = 'btn btn-secondary text-left p-3 flex justify-between items-center';
                            satElement.innerHTML = `
                                <div class="flex-grow cursor-pointer" data-tle="${sat.tle}"><span class="font-bold block text-base"><i class="fa-solid fa-satellite-dish mr-3 text-secondary"></i>${sat.name}</span></div>
                                <button class="btn !p-0 h-9 w-9 flex-shrink-0 flex items-center justify-center text-red-400 hover:bg-red-500/20 delete-sat-btn" data-index="${index}" title="Eliminar"><i class="fa-solid fa-trash-can"></i></button>`;
                            mySatellitesList.appendChild(satElement);
                        });
                        mySatellitesList.querySelectorAll('.flex-grow').forEach(btn => btn.addEventListener('click', (e) => this.handleTrack(e.currentTarget.dataset.tle)));
                        mySatellitesList.querySelectorAll('.delete-sat-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); this.handleDelete(parseInt(e.currentTarget.dataset.index, 10)); }));
                    },
                    handleSaveTle() {
                        const { tleInput } = App.elements, tleData = tleInput.value.trim(), parsedSats = App.satellites.parseTLE(tleData);
                        if(parsedSats.length === 0 || !parsedSats[0].name){ App.playSound('error', 'C3'); return; }
                        const newSat = { name: parsedSats[0].name, tle: `${parsedSats[0].name}\n${parsedSats[0].line1}\n${parsedSats[0].line2}` };
                        const mySats = this.loadFromStorage(); mySats.push(newSat); this.saveToStorage(mySats);
                        App.playSound('success', 'G5'); App.ui.hideModal(App.elements.tleModal); this.renderList(); App.ui.updateButtonsState();
                    },
                    handleDelete(index) {
                        const mySats = this.loadFromStorage(), satToDelete = mySats[index];
                        if (!satToDelete) return;
                        App.elements.confirmModalText.textContent = `¿Seguro que deseas eliminar "${satToDelete.name}"?`;
                        App.elements.confirmDeleteBtn.dataset.index = index; App.ui.showModal(App.elements.confirmModal);
                    },
                    confirmDelete(event) {
                        const index = parseInt(event.currentTarget.dataset.index, 10);
                        if (isNaN(index)) return;
                        App.playSound('trash'); let mySats = this.loadFromStorage(); mySats.splice(index, 1); this.saveToStorage(mySats);
                        this.renderList(); App.ui.hideModal(App.elements.confirmModal); App.ui.updateButtonsState();
                    },
                    handleTrack(tleString) {
                        App.playSound('success', 'G4'); App.elements.tleInput.value = tleString;
						App.satellites.handleTleLoad(true); App.ui.showScreen('app-container');
						if (App.state.trackedSatellites.length > 0) {
							App.satellites.handleTracking();
							App.satellites.centerOnSatellite();
						}
                    },
                    loadFromStorage() { try { const data = localStorage.getItem(App.config.localStorageKey); return data ? JSON.parse(data) : []; } catch (e) { return []; } },
                    saveToStorage(satellites) { try { localStorage.setItem(App.config.localStorageKey, JSON.stringify(satellites)); } catch (e) { console.error(e); } }
                },

				satellites: {
					async updateTlesFromSource() {
						for (const [id, sat] of Object.entries(App.config.knownSatellites)) {
							const satElement = document.getElementById(`known-sat-${id}`);
							const statusIndicatorElement = satElement?.querySelector('.sat-status-indicator');
							try {
								const response = await fetch(`https://corsproxy.io/?https://celestrak.org/NORAD/elements/gp.php?CATNR=${sat.noradId}&FORMAT=TLE`);
								if (!response.ok) throw new Error(`HTTP error ${response.status}`);
								const tleText = await response.text();
								if (tleText && tleText.includes('1 ') && tleText.includes('2 ')) {
									App.config.knownSatellites[id].tle = tleText.trim();
									if (satElement) {
										satElement.classList.remove('is-loading', 'is-error');
										if (statusIndicatorElement) {
											statusIndicatorElement.innerHTML = `<span class="text-green-400">TLE actualizado</span>`;
                                            setTimeout(() => { if (statusIndicatorElement) statusIndicatorElement.style.display = 'none'; }, 2000);
										}
									}
								} else { throw new Error('Invalid TLE data'); }
							} catch (error) {
								console.error(`Failed TLE fetch for ${sat.name}:`, error);
								App.config.knownSatellites[id].tle = null;
								if (satElement) {
									satElement.classList.remove('is-loading'); satElement.classList.add('is-error');
									if (statusIndicatorElement) statusIndicatorElement.innerHTML = `<span class="text-red-400">Error al actualizar.</span>`;
								}
							}
						}
					},
					
					loadKnown(satId) {
						const satData = App.config.knownSatellites[satId];
						if (!satData || !satData.tle) { App.playSound('error', 'D3'); return; }
						App.playSound('success', 'G4'); App.elements.tleInput.value = satData.tle;
						this.handleTleLoad(true); App.ui.showScreen('app-container');
						if (App.state.trackedSatellites.length > 0) {
							this.handleTracking();
							this.centerOnSatellite();
						}
					},

					handleTleLoad(isSilent = false) {
						const { tleInput, tleStatus, satelliteInfoHeader, satelliteNameDisplay } = App.elements;
						const tleData = tleInput.value;
						if (!tleData.trim()) { if (!isSilent) App.playSound('error', 'C3'); return; }

						this.clearMapLayers(); App.state.trackedSatellites = [];
						
						const parsedSatellites = this.parseTLE(tleData);
						if (parsedSatellites.length === 0) {
							if (!isSilent) App.playSound('error', 'C3');
							tleStatus.textContent = 'Error en los datos.'; tleStatus.className = 'text-xs text-center text-red-400';
							return;
						}

						parsedSatellites.forEach(sat => {
							try {
								const satrec = satellite.twoline2satrec(sat.line1, sat.line2);
								App.state.trackedSatellites.push({ name: sat.name, satrec, marker: null, orbitLayers: [] });
							} catch(e) { console.error("Error processing TLE for:", sat.name, e); }
						});

						if (App.state.trackedSatellites.length > 0) {
							const count = App.state.trackedSatellites.length;
							const satName = App.state.trackedSatellites[0].name || 'Satélite';

							satelliteNameDisplay.textContent = satName;
							satelliteInfoHeader.classList.remove('hidden');
							
							tleStatus.textContent = `${count > 1 ? `${count} satélites` : satName} cargado.`;
							tleStatus.className = 'text-xs text-center text-green-400';
							if (!isSilent) App.playSound('success', 'G4');
						}
						
						App.ui.updateButtonsState();
						if (!isSilent) App.ui.hideModal(App.elements.tleModal);
					},

					parseTLE(tleString) {
						const lines = tleString.trim().split('\n').map(l => l.trim()), satellites = [];
						for (let i = 0; i < lines.length; i++) {
							let name, line1, line2;
							const isLine1 = (l) => l?.startsWith('1 '), isLine2 = (l) => l?.startsWith('2 ');
							if (!isLine1(lines[i]) && isLine1(lines[i+1]) && isLine2(lines[i+2])) {
								name = lines[i]; line1 = lines[i+1]; line2 = lines[i+2];
								satellites.push({ name, line1, line2 }); i += 2;
							} else if (isLine1(lines[i]) && isLine2(lines[i+1])) {
								name = `SAT-${lines[i].substring(2, 7)}`; line1 = lines[i]; line2 = lines[i+1];
								satellites.push({ name, line1, line2 }); i += 1;
							}
						}
						return satellites;
					},

					handleTracking() {
						this.clearMapLayers();
						App.state.trackedSatellites.forEach(sat => {
							sat.marker = L.marker([0, 0], {
								icon: L.divIcon({ className: '', html: '<div class="satellite-dot-icon"></div>', iconSize: [12, 12], iconAnchor: [6, 6] })
							}).addTo(App.state.map).bindTooltip(sat.name, { permanent: true, direction: 'right', offset: [15, 0], className: 'satellite-label' });
						});
						App.time.startRealTimeUpdates();
					},

					updatePositions() {
						const { map, currentTime } = App.state;
						App.state.trackedSatellites.forEach(sat => {
							if (!sat.satrec) return;
							try {
								const posVel = satellite.propagate(sat.satrec, currentTime), gmst = satellite.gstime(currentTime);
								const posGd = satellite.eciToGeodetic(posVel.position, gmst);
								if(sat.marker) sat.marker.setLatLng([satellite.radiansToDegrees(posGd.latitude), satellite.radiansToDegrees(posGd.longitude)]);
							} catch (e) {
								App.time.stopRealTimeUpdates(); console.error(`Propagation error for ${sat.name}`, e);
								if (sat.marker) map.removeLayer(sat.marker);
								if (sat.orbitLayers) sat.orbitLayers.forEach(layer => map.removeLayer(layer));
							}
						});
					},

					drawOrbits() {
						const { map, currentTime } = App.state;
						App.state.trackedSatellites.forEach(sat => {
							if (sat.orbitLayers) sat.orbitLayers.forEach(layer => map.removeLayer(layer));
							sat.orbitLayers = [];
							const path = [], period = (2 * Math.PI) / sat.satrec.no, step = period / 100;
							for (let i = 0; i <= period; i += step) {
								const time = new Date(currentTime.getTime() + i * 60000);
								try {
									const pnv = satellite.propagate(sat.satrec, time), gmst = satellite.gstime(time), posGd = satellite.eciToGeodetic(pnv.position, gmst);
									path.push([satellite.radiansToDegrees(posGd.latitude), satellite.radiansToDegrees(posGd.longitude)]);
								} catch (e) { continue; }
							}
							if (path.length < 2) return;
							const multiPath = []; let currentSegment = [path[0]];
							for (let i = 1; i < path.length; i++) {
								if (Math.abs(path[i][1] - path[i-1][1]) > 180) { multiPath.push(currentSegment); currentSegment = []; }
								currentSegment.push(path[i]);
							}
							multiPath.push(currentSegment);
							
							multiPath.forEach(segment => { 
								if (segment.length > 1) {
									sat.orbitLayers.push(L.polyline(segment, { className: 'orbit-path' }).addTo(map));
									sat.orbitLayers.push(L.polyline(segment.map(p => [p[0], p[1] + 360]), { className: 'orbit-path' }).addTo(map));
									sat.orbitLayers.push(L.polyline(segment.map(p => [p[0], p[1] - 360]), { className: 'orbit-path' }).addTo(map));
								}
							});
						});
					},
					
					centerOnSatellite() {
						if (App.state.trackedSatellites.length > 0 && App.state.map) {
							const sat = App.state.trackedSatellites[0];
							try {
								const posVel = satellite.propagate(sat.satrec, App.state.currentTime);
								const gmst = satellite.gstime(App.state.currentTime);
								const posGd = satellite.eciToGeodetic(posVel.position, gmst);
								const lat = satellite.radiansToDegrees(posGd.latitude);
								const lon = satellite.radiansToDegrees(posGd.longitude);
								App.state.map.flyTo([lat, lon]); 
							} catch(e) {
								console.error("No se pudo calcular la posición para centrar el satélite:", e);
							}
						}
					},
					
					clearMapLayers() {
						const { map } = App.state; if (!map) return;
						App.time.stopRealTimeUpdates();
						App.state.trackedSatellites.forEach(sat => {
							if (sat.marker && map.hasLayer(sat.marker)) map.removeLayer(sat.marker); sat.marker = null;
							if (sat.orbitLayers) sat.orbitLayers.forEach(layer => map.removeLayer(layer)); sat.orbitLayers = [];
						});
					},

					clearAll() {
						this.clearMapLayers(); App.time.stopTimeTravel(); App.state.trackedSatellites = [];
						App.prediction.clearVisibilityBands();
						App.elements.tleStatus.textContent = 'No hay datos cargados.'; App.elements.tleStatus.className = 'text-xs text-center text-gray-400';
						App.elements.satelliteInfoHeader.classList.add('hidden');
						App.elements.satelliteNameDisplay.textContent = '';
						App.ui.updateButtonsState();
					},

					showInfoModal() {
						if (App.state.trackedSatellites.length === 0) return;
						const sat = App.state.trackedSatellites[0];
						const { satelliteInfoModalTitle, satelliteInfoContent } = App.elements;

						App.playSound('uiClick', 'E4');

						try {
							const posVel = satellite.propagate(sat.satrec, App.state.currentTime);
							const gmst = satellite.gstime(App.state.currentTime);
							const posGd = satellite.eciToGeodetic(posVel.position, gmst);
							
							const vel = posVel.velocity;
							const speed = Math.sqrt(vel.x * vel.x + vel.y * vel.y + vel.z * vel.z);

							satelliteInfoModalTitle.textContent = `Info: ${sat.name}`;
							satelliteInfoContent.innerHTML = `
								<div class="grid grid-cols-2 gap-4">
									<div>
										<p class="font-bold text-text-primary">Altura:</p>
										<p class="font-mono text-lg text-secondary">${posGd.height.toFixed(2)} km</p>
									</div>
									<div>
										<p class="font-bold text-text-primary">Velocidad:</p>
										<p class="font-mono text-lg text-secondary">${speed.toFixed(2)} km/s</p>
									</div>
									<div>
										<p class="font-bold text-text-primary">Latitud:</p>
										<p class="font-mono text-lg text-secondary">${satellite.radiansToDegrees(posGd.latitude).toFixed(4)}°</p>
									</div>
									<div>
										<p class="font-bold text-text-primary">Longitud:</p>
										<p class="font-mono text-lg text-secondary">${satellite.radiansToDegrees(posGd.longitude).toFixed(4)}°</p>
									</div>
								</div>
							`;
						} catch(e) {
							satelliteInfoContent.innerHTML = `<p class="text-danger">No se pudo calcular la información para este satélite en el momento actual.</p>`;
							console.error("Error calculating satellite info:", e);
						}

						App.ui.showModal(App.elements.satelliteInfoModal);
					}
				},
				
				location: {
                    saveToStorage(loc) { try { localStorage.setItem(App.config.locationStorageKey, JSON.stringify(loc)); } catch (e) { console.error(e); } },
                    loadFromStorage() {
                        try {
                            const savedLoc = localStorage.getItem(App.config.locationStorageKey);
                            if (savedLoc) {
                                const { lat, lon, name } = JSON.parse(savedLoc);
                                App.state.observerCoords = [lat, lon];
                                App.elements.locationInput.value = name;
                                App.elements.locationFeedback.textContent = `Ubicación: ${name}`;
                                App.elements.locationFeedback.className = 'text-xs text-center mt-1 text-green-400 h-4';
                                App.ui.updateButtonsState();
                            }
                        } catch (e) { console.error(e); }
                    },
                    applySavedLocationToMap() {
                        if (App.state.observerCoords && App.state.mapInitialized) {
                            if (App.state.userLocationMarker) App.state.map.removeLayer(App.state.userLocationMarker);
                            App.state.userLocationMarker = L.marker(App.state.observerCoords, {
                                icon: L.divIcon({ className: '', html: '<div class="user-location-icon"></div>', iconSize: [14, 14], iconAnchor: [7, 7] })
                            }).addTo(App.state.map);
                        }
                    },
					async handleCitySearch() {
						const { locationInput, locationFeedback } = App.elements, cityName = locationInput.value.trim();
						if (App.state.userLocationMarker) { App.state.map.removeLayer(App.state.userLocationMarker); App.state.userLocationMarker = null; }
						if (cityName.length < 3) {
							App.state.observerCoords = null; locationFeedback.textContent = '';
                            localStorage.removeItem(App.config.locationStorageKey); App.time.updateClockPill(); App.ui.updateButtonsState();
							return;
						}
						locationFeedback.textContent = `Buscando...`; locationFeedback.className = 'text-xs text-center mt-1 text-blue-400 h-4';
						try {
							const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1&accept-language=es`);
							const data = await response.json();
							if (data && data.length > 0) {
								const { lat, lon, display_name } = data[0], simpleName = display_name.split(',')[0];
								App.state.observerCoords = [parseFloat(lat), parseFloat(lon)];
								locationFeedback.textContent = `Ubicación: ${simpleName}`; locationFeedback.className = 'text-xs text-center mt-1 text-green-400 h-4';
								App.playSound('success', 'E4');
								App.state.userLocationMarker = L.marker(App.state.observerCoords, {
									icon: L.divIcon({ className: '', html: '<div class="user-location-icon"></div>', iconSize: [14, 14], iconAnchor: [7, 7] })
								}).addTo(App.state.map);
								App.state.map.flyTo(App.state.observerCoords, 5);
                                this.saveToStorage({ lat: parseFloat(lat), lon: parseFloat(lon), name: simpleName }); App.time.updateClockPill();
							} else { this.setError('Ciudad no encontrada.'); }
						} catch(error) { this.setError('Error de red.'); }
						App.ui.updateButtonsState();
					},
					setError(msg) { App.state.observerCoords = null; App.elements.locationFeedback.textContent = msg; App.elements.locationFeedback.className = 'text-xs text-center mt-1 text-red-400 h-4'; App.playSound('error', 'C3'); },
					clear() {
						if (App.state.userLocationMarker) App.state.map.removeLayer(App.state.userLocationMarker);
						App.state.userLocationMarker = null; App.elements.locationInput.value = ''; App.elements.locationFeedback.textContent = '';
						App.state.observerCoords = null; localStorage.removeItem(App.config.locationStorageKey); App.time.updateClockPill();
					}
				},

				prediction: {
					handlePrediction() {
						if (App.state.trackedSatellites.length === 0 || !App.state.observerCoords) return;
						const satToPredict = App.state.trackedSatellites[0];
						App.elements.passesModalTitle.textContent = `Próximos Pasos para ${satToPredict.name}`;
						App.elements.resultsContainer.innerHTML = `<div class="text-center p-8"><i class="fa-solid fa-spinner fa-spin text-3xl"></i><p class="mt-4">Calculando...</p></div>`;
						App.ui.showModal(App.elements.passesModal); App.playSound('uiClick', 'D4');
						setTimeout(() => { const passes = this.calculateVisiblePasses(satToPredict, App.state.observerCoords); this.displayPasses(passes, satToPredict.name); }, 200);
					},
					calculateVisiblePasses(sat, coords) {
						const observerGd = { latitude: satellite.degreesToRadians(coords[0]), longitude: satellite.degreesToRadians(coords[1]), height: 0.1 };
						const now = new Date(), totalMinutes = 30 * 24 * 60, finalPasses = [];
						let inPass = false, currentPass = null;
						for (let i = 0; i < totalMinutes; i++) {
							const time = new Date(now.getTime() + i * 60000);
							try {
								const posVel = satellite.propagate(sat.satrec, time), gmst = satellite.gstime(time);
								const posEcf = satellite.eciToEcf(posVel.position, gmst), lookAngles = satellite.ecfToLookAngles(observerGd, posEcf);
								const elevation = satellite.radiansToDegrees(lookAngles.elevation);
								if (elevation > 10 && !inPass) { inPass = true; currentPass = { start: time, maxElevation: 0, points: [], isVisible: false }; }
								if (inPass) {
									const sunElevation = SunCalc.getPosition(time, coords[0], coords[1]).altitude * (180 / Math.PI);
									const isVisibleWindow = sunElevation < -6 && sunElevation > -18;
									currentPass.points.push({ time, elevation, isNight: isVisibleWindow });
									if (elevation > currentPass.maxElevation) currentPass.maxElevation = elevation;
									if (isVisibleWindow) currentPass.isVisible = true;
								}
								if (elevation < 10 && inPass) {
									inPass = false; currentPass.end = time;
									if (currentPass.isVisible && currentPass.points.length > 1) finalPasses.push(currentPass);
									if (finalPasses.length >= 20) break;
								}
							} catch (e) { inPass = false; continue; }
						}
						return finalPasses;
					},
                    formatPassDate(date) { const months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic']; return `${date.getDate()} ${months[date.getMonth()]}`; },
                    getElevationColor(elevation) {
                        const factor = (Math.max(10, Math.min(90, elevation)) - 10) / 80;
                        const r = Math.round(100 + (250 - 100) * factor), g = Math.round(100 + (220 - 100) * factor), b = Math.round(100 + (40 - 100) * factor);
                        return `rgb(${r}, ${g}, ${b})`;
                    },
					displayPasses(passes, satName) {
						const { resultsContainer } = App.elements;
						if (passes.length === 0) { resultsContainer.innerHTML = `<p class="text-center p-4">No se encontraron pasos visibles.</p>`; return; }
						const tableHtml = `<p class="mb-4 text-sm text-gray-400">Clic para viajar a ese momento. Horas locales.</p><div class="overflow-x-auto"><table class="w-full text-left text-sm">
									<thead class="bg-gray-700/50 uppercase text-xs"><tr><th class="p-3 text-center">Fecha</th><th class="p-3">Horario</th><th class="p-3 text-right">Elev. Máx.</th></tr></thead>
									<tbody>${passes.map(pass => `<tr class="border-b border-gray-700 hover:bg-gray-700/30 cursor-pointer pass-row" data-timestamp="${pass.start.getTime()}">
												<td class="p-3 align-middle text-center"><span class="inline-block font-bold text-white px-3 py-1.5 rounded-lg border-2" style="border-color: ${this.getElevationColor(pass.maxElevation)};">${this.formatPassDate(pass.start)}</span></td>
                                                <td class="p-3 align-middle font-mono text-xs md:text-sm"><div>${pass.start.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}</div><div>${pass.end.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}</div></td>
                                                <td class="p-3 align-middle text-right font-bold text-lg" style="color: ${this.getElevationColor(pass.maxElevation)};">${pass.maxElevation.toFixed(1)}°</td></tr>`).join('')}</tbody></table></div>`;
						resultsContainer.innerHTML = tableHtml;
						resultsContainer.querySelectorAll('.pass-row').forEach(row => row.addEventListener('click', (e) => this.jumpToPassTime(e.currentTarget.dataset.timestamp)));
					},
					getSunEci(date) {
						const jday = satellite.jday(date), mjd = jday - 2400000.5, jd2000 = mjd - 51544.5;
						const MA = (357.5291 + 0.98560028 * jd2000) % 360, MArad = satellite.degreesToRadians(MA);
						const L = (280.459 + 0.98564736 * jd2000) % 360, C = 1.915 * Math.sin(MArad) + 0.020 * Math.sin(2 * MArad);
						const lambda = satellite.degreesToRadians((L + C) % 360), epsilon = satellite.degreesToRadians(23.4393 - 3.563E-7 * jd2000);
						const R_AU = 1.00014 - 0.01671 * Math.cos(MArad) - 0.00014 * Math.cos(2 * MArad), R_km = R_AU * 149597870.7;
						return { x: R_km * Math.cos(lambda), y: R_km * Math.sin(lambda) * Math.cos(epsilon), z: R_km * Math.sin(lambda) * Math.sin(epsilon) };
					},
					isSatIlluminated(satEci, date) {
						const sunEci = this.getSunEci(date);
						const dotProduct = (satEci.x * sunEci.x) + (satEci.y * sunEci.y) + (satEci.z * sunEci.z);
						if (dotProduct > 0) return true;
						const satMagSq = (satEci.x ** 2) + (satEci.y ** 2) + (satEci.z ** 2), sunMagSq = (sunEci.x ** 2) + (sunEci.y ** 2) + (sunEci.z ** 2);
						return (satMagSq - (dotProduct ** 2 / sunMagSq)) > (6378.137 ** 2);
					},
					drawPassTrajectory(sat, startTime, coords) {
						const { map } = App.state; if (!map || !sat.satrec) return;
						if (sat.orbitLayers) sat.orbitLayers.forEach(layer => map.removeLayer(layer)); sat.orbitLayers = [];
						const observerGd = { latitude: satellite.degreesToRadians(coords[0]), longitude: satellite.degreesToRadians(coords[1]), height: 0.1 };
						const masterPath = [], loopStart = new Date(startTime.getTime() - (20) * 60000);
						for (let i = 0; i < (60 * 60) / 10; i++) {
							const time = new Date(loopStart.getTime() + i * 10 * 1000);
							try {
								const posVel = satellite.propagate(sat.satrec, time), gmst = satellite.gstime(time);
								const posEcf = satellite.eciToEcf(posVel.position, gmst), lookAngles = satellite.ecfToLookAngles(observerGd, posEcf);
								if (satellite.radiansToDegrees(lookAngles.elevation) < 0) continue;
								const posGd = satellite.eciToGeodetic(posVel.position, gmst);
								const isObserverDark = SunCalc.getPosition(time, coords[0], coords[1]).altitude * (180 / Math.PI) < -6;
								masterPath.push({ lat: satellite.radiansToDegrees(posGd.latitude), lon: satellite.radiansToDegrees(posGd.longitude), isVisible: isObserverDark && this.isSatIlluminated(posVel.position, time) });
							} catch (e) { continue; }
						}
						if (masterPath.length < 2) return [];
						const visibleSegments = [], shadowSegments = []; let currentSegment = [];
						for (let i = 0; i < masterPath.length; i++) {
							const point = masterPath[i], prevPoint = i > 0 ? masterPath[i-1] : null;
							if (prevPoint && (point.isVisible !== prevPoint.isVisible || Math.abs(point.lon - prevPoint.lon) > 180)) {
								if (currentSegment.length > 1) (prevPoint.isVisible ? visibleSegments : shadowSegments).push(currentSegment);
								currentSegment = [[prevPoint.lat, prevPoint.lon]];
							}
							currentSegment.push([point.lat, point.lon]);
						}
						if (currentSegment.length > 1) (masterPath[masterPath.length-1].isVisible ? visibleSegments : shadowSegments).push(currentSegment);
						visibleSegments.forEach(segment => sat.orbitLayers.push(L.polyline(segment, { className: 'orbit-path' }).addTo(map)));
						shadowSegments.forEach(segment => sat.orbitLayers.push(L.polyline(segment, { className: 'orbit-path-shadow' }).addTo(map)));
						return visibleSegments;
					},
					jumpToPassTime(timestamp) {
						const time = parseInt(timestamp, 10); if (isNaN(time)) return;
						App.playSound('success', 'A4');
						App.time.startTimeTravel();
						App.state.isPassViewActive = true;
						App.state.currentTime = new Date(time);
						
						this.clearVisibilityBands();
						const satToDraw = App.state.trackedSatellites[0];
						if (satToDraw && App.state.observerCoords) {
							if (satToDraw.orbitLayers) satToDraw.orbitLayers.forEach(layer => App.state.map.removeLayer(layer));
							satToDraw.orbitLayers = [];
							
							const visibleSegments = this.drawPassTrajectory(satToDraw, new Date(time), App.state.observerCoords);
							
							if (visibleSegments && visibleSegments.length > 0) {
								this.drawVisibilityBands(visibleSegments, satToDraw); // MODIFICADO: Pasar el satélite
								App.elements.visibilityControls.classList.remove('hidden');
								App.elements.toggleVisibilityBandsBtn.classList.remove('hidden');
							}
						}

						App.satellites.updatePositions(); App.time.updateTimeUI(); App.time.updateClockPill();
						App.ui.hideModal(App.elements.passesModal);
						App.elements.mainControlPanel.classList.remove('expanded'); App.elements.timeControlPanel.classList.remove('visible'); 
						if (App.state.observerCoords) App.state.map.flyTo(App.state.observerCoords, 5);
					},
                    getGroundRadiusForElevation(elevationDegrees, altitudeKm) {
                        const R = 6371; // Radio de la Tierra en km
                        const elevRads = satellite.degreesToRadians(elevationDegrees);
                        const beta = Math.asin((R / (R + altitudeKm)) * Math.cos(elevRads));
                        const phi = Math.PI / 2 - elevRads - beta;
                        return R * phi;
                    },

					drawVisibilityBands(trajectories, sat) {
						if (!trajectories || trajectories.length === 0 || !sat) return;
						this.clearVisibilityBands(); 
						App.state.visibilityBands.trajectory = trajectories;

                        let altitude = 400; // Valor por defecto
                        try {
                            const midPassTime = new Date(App.state.currentTime.getTime());
                            const posVel = satellite.propagate(sat.satrec, midPassTime);
                            const gmst = satellite.gstime(midPassTime);
                            const posGd = satellite.eciToGeodetic(posVel.position, gmst);
                            altitude = posGd.height;
                        } catch (e) {
                            console.error("No se pudo calcular la altitud del satélite, usando valor por defecto.");
                        }

                        const distances = {
                            periferica: this.getGroundRadiusForElevation(10, altitude),
                            media: this.getGroundRadiusForElevation(30, altitude),
                            optima: this.getGroundRadiusForElevation(60, altitude),
                        };

						const colors = { 
							periferica: 'rgba(248, 81, 73, 0.15)', 
							media: 'rgba(247, 181, 48, 0.2)', 
							optima: 'rgba(57, 211, 83, 0.25)'
						};

						trajectories.forEach(trajectory => {
							if (trajectory.length < 2) return;

							const boundaries = {
								periferica: { left: [], right: [] },
								media: { left: [], right: [] },
								optima: { left: [], right: [] },
							};
							
							for (let i = 0; i < trajectory.length; i++) {
								const p1 = trajectory[i];

								let bearing;
								if (i === 0) {
									bearing = calculateBearing(p1, trajectory[i + 1]);
								} else if (i === trajectory.length - 1) {
									bearing = calculateBearing(trajectory[i - 1], p1);
								} else {
									const bearingFromPrev = calculateBearing(trajectory[i - 1], p1);
									const bearingToNext = calculateBearing(p1, trajectory[i + 1]);
									let angleDiff = bearingToNext - bearingFromPrev;
									if (angleDiff > 180) angleDiff -= 360;
									if (angleDiff < -180) angleDiff += 360;
									bearing = bearingFromPrev + angleDiff / 2;
								}
								
								for (const band of ['periferica', 'media', 'optima']) {
									const dist = distances[band];
									boundaries[band].right.push(calculateDestinationPoint(p1[0], p1[1], bearing + 90, dist));
									boundaries[band].left.push(calculateDestinationPoint(p1[0], p1[1], bearing - 90, dist));
								}
							}
                            
							// ==================================================================
							// INICIO DE LA MODIFICACIÓN: DIBUJAR BANDAS CON BORDES REDONDEADOS
							// ==================================================================
							['periferica', 'media', 'optima'].forEach(band => {
								const dist = distances[band];
								const rightPoints = boundaries[band].right;
								const leftPoints = boundaries[band].left;

								if (rightPoints.length < 1 || leftPoints.length < 1) return;
								
								const path = [];
								
								// 1. Añadir los puntos del borde derecho
								path.push(...rightPoints);

								// 2. Añadir el arco del final de la trayectoria
								const endPoint = trajectory[trajectory.length - 1];
								const endBearing = calculateBearing(trajectory[trajectory.length - 2], trajectory[trajectory.length - 1]);
								// ==================================================================
								// LÍNEA CORREGIDA
								// ==================================================================
								for (let angle = endBearing + 90; angle >= endBearing - 90; angle -= 10) {
									path.push(calculateDestinationPoint(endPoint[0], endPoint[1], angle, dist));
								}
								
								// 3. Añadir los puntos del borde izquierdo (en orden inverso)
								path.push(...leftPoints.reverse());
								
								// 4. Añadir el arco del inicio de la trayectoria para cerrar el polígono
								const startPoint = trajectory[0];
								const startBearing = calculateBearing(trajectory[0], trajectory[1]);
								for (let angle = startBearing - 90; angle >= startBearing - 270; angle -= 10) {
									 path.push(calculateDestinationPoint(startPoint[0], startPoint[1], angle, dist));
								}

								const polygon = L.polygon(path, {
									fillColor: colors[band],
									fillOpacity: 1,
									weight: 0,
								});
								App.state.visibilityBands.layers.push(polygon);
							});
							// ==================================================================
							// FIN DE LA MODIFICACIÓN
							// ==================================================================
						});
					},
					toggleVisibilityBands() {
						App.playSound('uiClick', 'F4');
						const { visibilityBands, map } = App.state;
						const button = App.elements.toggleVisibilityBandsBtn;
						const legend = App.elements.visibilityLegend;
						visibilityBands.visible = !visibilityBands.visible;

						if (visibilityBands.visible) {
							visibilityBands.layers.forEach(layer => layer.addTo(map));
							button.classList.add('active');
							legend.classList.remove('hidden');
						} else {
							visibilityBands.layers.forEach(layer => map.removeLayer(layer));
							button.classList.remove('active');
							legend.classList.add('hidden');
						}
					},
					clearVisibilityBands() {
						const { visibilityBands, map } = App.state;
						if (visibilityBands.layers.length > 0) {
							visibilityBands.layers.forEach(layer => {
                                if (map.hasLayer(layer)) {
                                    map.removeLayer(layer);
                                }
                            });
						}
						visibilityBands.layers = [];
						visibilityBands.trajectory = [];
						visibilityBands.visible = false;
						App.elements.visibilityControls.classList.add('hidden');
						App.elements.visibilityLegend.classList.add('hidden');
						App.elements.toggleVisibilityBandsBtn.classList.add('hidden');
						App.elements.toggleVisibilityBandsBtn.classList.remove('active');
					}
				},
				
				time: {
                    updateClockPill() {
                        const { toggleTimeControlBtn } = App.elements, currentTime = App.state.currentTime;
                        let displayHtml;
                        if (App.state.observerCoords) {
                            displayHtml = `<span>LOCAL: ${currentTime.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}</span>`;
                        } else {
                            displayHtml = `<span>UTC: ${currentTime.toISOString().substring(11, 19)}</span>`;
                        }
                        if (toggleTimeControlBtn) toggleTimeControlBtn.innerHTML = displayHtml;
                    },
					updateMapForCurrentTime() {
						App.satellites.updatePositions();
						if (!App.state.isPassViewActive) {
							App.satellites.drawOrbits();
						}
						this.updateTimeUI(); 
                        this.updateClockPill();
					},
					startRealTimeUpdates() {
						this.stopRealTimeUpdates(); this.updateClockPill();
						App.state.realTimeInterval = setInterval(() => {
							if (!App.state.isTimeTraveling) { App.state.currentTime = new Date(); this.updateMapForCurrentTime(); }
						}, 1000); 
						this.updateMapForCurrentTime();
					},
					stopRealTimeUpdates() { clearInterval(App.state.realTimeInterval); App.state.realTimeInterval = null; },
					startTimeTravel() {
						if (!App.state.isTimeTraveling) {
							App.state.isTimeTraveling = true; this.stopRealTimeUpdates();
							App.elements.toggleTimeControlBtn.classList.add('time-traveling-active');
							App.state.trackedSatellites.forEach(sat => {
								if (sat.orbitLayers) sat.orbitLayers.forEach(layer => App.state.map.removeLayer(layer));
								sat.orbitLayers = [];
							});
						}
					},
					stopTimeTravel() {
						if(App.state.isTimeTraveling) { 
							App.state.isTimeTraveling = false; 
							App.state.isPassViewActive = false;
							App.elements.toggleTimeControlBtn.classList.remove('time-traveling-active'); 
							App.prediction.clearVisibilityBands();
						}
						App.state.currentTime = new Date(); this.startRealTimeUpdates();
					},
					adjustTime(direction) {
						this.startTimeTravel();
						App.state.currentTime.setTime(App.state.currentTime.getTime() + (App.config.timeSteps[App.state.timeStepIndex].value * direction));
						this.updateMapForCurrentTime();
					},
					setTimeFromInputs() {
						this.startTimeTravel();
						const { dateInput, timeInput } = App.elements;
						if(dateInput.value && timeInput.value) { App.state.currentTime = new Date(`${dateInput.value}T${timeInput.value}`); this.updateMapForCurrentTime(); }
					},
					setTimeFromSlider() {
						this.startTimeTravel();
						const totalMinutes = parseInt(App.elements.timelineSlider.value, 10);
						App.state.currentTime.setHours(Math.floor(totalMinutes / 60), totalMinutes % 60, 0, 0);
						this.updateMapForCurrentTime();
					},
					updateTimeUI() {
						const { dateInput, timeInput, timelineSlider } = App.elements, time = App.state.currentTime;
						dateInput.value = `${time.getFullYear()}-${(time.getMonth() + 1).toString().padStart(2, '0')}-${time.getDate().toString().padStart(2, '0')}`;
						timeInput.value = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
						timelineSlider.value = time.getHours() * 60 + time.getMinutes();
					}
				}
			};
			App.init();
		});
	</script>
</body>
</html>

